<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Creates ETag middleware object — ETagMiddleware • RestRserve</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Creates ETag middleware object — ETagMiddleware"><meta property="og:description" content='Adds ETag to an Application. 
ETags are header information that enable the caching of content.
If enabled, RestRserve will return an ETag (eg a hash of a file) alongside
the last time it was modified.
When a request is sent, additional headers such as
If-None-Match,
If-Match,
If-Modified-Since,
and
If-Unmodified-Since,
can be passed to the server as well.
If the conditions are met (different hash in case of a If-None-Match header
or a later file modification in case of a given If-Modified-Since header),
the server does not send the requested file but returns a
304 status
code, indicating, that the data on the requesting device is up-to-date.
Note that if both headers are provided, the If-None-Match header takes
precedence.
Furthermore, the middleware also supports the headers If-Match, which
returns the object if the hash matches (it also supports "*" to always return
the file), as well as If-Unmodified-Since, which returns the object if it
has not been modified since a certain time.
If the conditions are not met, a
412 status
code is returned (Precondition Failed).
See examples below.'><meta property="og:image" content="https://restrserve.org/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RestRserve</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/RestRserve.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/Authentication.html">Authentication</a>
    </li>
    <li>
      <a href="../articles/benchmarks/Benchmarks.html">Benchmarks</a>
    </li>
    <li>
      <a href="../articles/ContentHandlers.html">Body encoding and decoding</a>
    </li>
    <li>
      <a href="../articles/Logging.html">Logging</a>
    </li>
    <li>
      <a href="../articles/Middleware.html">Middleware</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/rexyai/RestRserve/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Creates ETag middleware object</h1>
    <small class="dont-index">Source: <a href="https://github.com/rexyai/RestRserve/blob/HEAD/R/ETagMiddleware.R" class="external-link"><code>R/ETagMiddleware.R</code></a></small>
    <div class="hidden name"><code>ETagMiddleware.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Adds ETag to an <a href="Application.html">Application</a>. <br></p>
<p>ETags are header information that enable the caching of content.
If enabled, RestRserve will return an ETag (eg a hash of a file) alongside
the last time it was modified.
When a request is sent, additional headers such as
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match" class="external-link"><code>If-None-Match</code></a>,
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Match" class="external-link"><code>If-Match</code></a>,
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Modified-Since" class="external-link"><code>If-Modified-Since</code></a>,
and
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-UnModified-Since" class="external-link"><code>If-Unmodified-Since</code></a>,
can be passed to the server as well.</p>
<p>If the conditions are met (different hash in case of a <code>If-None-Match</code> header
or a later file modification in case of a given <code>If-Modified-Since</code> header),
the server does not send the requested file but returns a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/304" class="external-link">304</a> status
code, indicating, that the data on the requesting device is up-to-date.</p>
<p>Note that if both headers are provided, the <code>If-None-Match</code> header takes
precedence.</p>
<p>Furthermore, the middleware also supports the headers <code>If-Match</code>, which
returns the object if the hash matches (it also supports "*" to always return
the file), as well as <code>If-Unmodified-Since</code>, which returns the object if it
has not been modified since a certain time.
If the conditions are not met, a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/412" class="external-link">412</a> status
code is returned (Precondition Failed).
See examples below.</p>
    </div>


    <div id="references">
    <h2>References</h2>
    <p><a href="https://developer.mozilla.org/en/docs/Web/HTTP/Headers/ETag" class="external-link">MDN</a></p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><a href="Middleware.html">Middleware</a> <a href="Application.html">Application</a></p></div>
    </div>
    <div id="super-class">
    <h2>Super class</h2>
    <p><code><a href="Middleware.html">RestRserve::Middleware</a></code> -&gt; <code>EtagMiddleware</code></p>
    </div>
    <div id="public-fields">
    <h2>Public fields</h2>
    <p></p><div class="r6-fields"><dl><dt><code>hash_function</code></dt>
<dd><p>Function that takes an object or file and computes
the hash of it</p></dd>


<dt><code>last_modified_function</code></dt>
<dd><p>Function that takes an object or file and
computes the last time it was modified</p></dd>


</dl><p></p></div>
    </div>
    <div id="methods">
    <h2>Methods</h2>
    
<div class="section">
<h3 id="public-methods">Public methods<a class="anchor" aria-label="anchor" href="#public-methods"></a></h3>

<ul><li><p><a href="#method-EtagMiddleware-new"><code>ETagMiddleware$new()</code></a></p></li>
<li><p><a href="#method-EtagMiddleware-clone"><code>ETagMiddleware$clone()</code></a></p></li>
</ul></div><p></p><hr><a id="method-EtagMiddleware-new"></a><div class="section">
<h3 id="method-new-">Method <code>new()</code><a class="anchor" aria-label="anchor" href="#method-new-"></a></h3>
<p>Creates ETag middleware object</p><div class="section">
<h4 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va"><a href="../reference/ETagMiddleware.html">ETagMiddleware</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  routes <span class="op">=</span> <span class="st">"/"</span>,</span>
<span>  match <span class="op">=</span> <span class="st">"partial"</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"ETagMiddleware"</span>,</span>
<span>  hash_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">body</span><span class="op">)</span> <span class="op">{</span></span>
<span>     <span class="kw">if</span> <span class="op">(</span><span class="st">"file"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">body</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>    <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">body</span><span class="op">[[</span><span class="st">"file"</span><span class="op">]</span><span class="op">]</span>, algo <span class="op">=</span> <span class="st">"crc32"</span><span class="op">)</span></span>
<span>     <span class="op">}</span></span>
<span>     <span class="kw">else</span> <span class="op">{</span></span>
<span>        </span>
<span>    <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span><span class="va">body</span>, algo <span class="op">=</span> <span class="st">"crc32"</span><span class="op">)</span></span>
<span>     <span class="op">}</span></span>
<span> <span class="op">}</span>,</span>
<span>  last_modified_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">body</span><span class="op">)</span> <span class="op">{</span></span>
<span>     <span class="kw">if</span> <span class="op">(</span><span class="st">"file"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">body</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>       </span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXlt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">body</span><span class="op">[[</span><span class="st">"file"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="st">"mtime"</span><span class="op">]</span><span class="op">]</span>, tz <span class="op">=</span> <span class="st">"GMT"</span><span class="op">)</span></span>
<span>     <span class="op">}</span></span>
<span>     <span class="kw">else</span> <span class="op">{</span></span>
<span>    </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXlt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, tz <span class="op">=</span> <span class="st">"GMT"</span><span class="op">)</span></span>
<span>     <span class="op">}</span></span>
<span> <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h4>
<p></p><div class="arguments"><dl><dt><code>routes</code></dt>
<dd><p>Routes paths to protect.</p></dd>


<dt><code>match</code></dt>
<dd><p>How routes will be matched: exact or partial (as prefix).</p></dd>


<dt><code>id</code></dt>
<dd><p>Middleware id.</p></dd>


<dt><code>hash_function</code></dt>
<dd><p>a function that generates the ETag hash.
The function takes the body of the response and returns a single
character. Default is crc32 using <a href="https://rdrr.io/pkg/digest/man/digest.html" class="external-link">digest::digest</a>.</p></dd>


<dt><code>last_modified_function</code></dt>
<dd><p>a function that takes the body of the
response and returns the last time this was changed. The default is to
take the mtime (last time the file was modified) if its a file,
if the body does not contain a file, the current time is returned (
resulting in no caching)</p></dd>


</dl><p></p></div>
</div>

</div><p></p><hr><a id="method-EtagMiddleware-clone"></a><div class="section">
<h3 id="method-clone-">Method <code>clone()</code><a class="anchor" aria-label="anchor" href="#method-clone-"></a></h3>
<p>The objects of this class are cloneable with this method.</p><div class="section">
<h4 id="usage-1">Usage<a class="anchor" aria-label="anchor" href="#usage-1"></a></h4>
<p></p><div class="r"><div class="sourceCode"><pre><code><span><span class="va">ETagMiddleware</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span>deep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div><p></p></div>
</div>

<div class="section">
<h4 id="arguments-1">Arguments<a class="anchor" aria-label="anchor" href="#arguments-1"></a></h4>
<p></p><div class="arguments"><dl><dt><code>deep</code></dt>
<dd><p>Whether to make a deep clone.</p></dd>


</dl><p></p></div>
</div>

</div>

    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">#############################################################################</span></span></span>
<span class="r-in"><span><span class="co"># setup a static directory with ETag caching</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">static_dir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"static"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">static_dir</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">static_dir</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">file_path</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">static_dir</span>, <span class="st">"example.txt"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="st">"Hello World"</span>, <span class="va">file_path</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># get the time the file was last modified in UTC time</span></span></span>
<span class="r-in"><span><span class="va">last_modified</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXlt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span><span class="op">[[</span><span class="st">"mtime"</span><span class="op">]</span><span class="op">]</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">file_hash</span> <span class="op">=</span> <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">file_path</span>, algo <span class="op">=</span> <span class="st">"crc32"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">time_fmt</span> <span class="op">=</span> <span class="st">"%a, %d %b %Y %H:%M:%S GMT"</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#############################################################################</span></span></span>
<span class="r-in"><span><span class="co"># setup the Application with the ETag Middleware</span></span></span>
<span class="r-in"><span><span class="va">app</span> <span class="op">=</span> <span class="va"><a href="Application.html">Application</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">append_middleware</span><span class="op">(</span><span class="va">ETagMiddleware</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">add_static</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/"</span>, <span class="va">static_dir</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#############################################################################</span></span></span>
<span class="r-in"><span><span class="co"># Example Requests</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Request the file returns the file with ETag headers</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># note that it also returns the Last-Modified and ETag headers</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 200 OK</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Last-Modified: Thu, 18 Apr 2024 01:54:58 GMT</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ETag: b095e5e3</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># provide matching hash of the file in the If-None-Match header to check Etag</span></span></span>
<span class="r-in"><span><span class="co"># =&gt; 304 Not Modified (Can be cached)</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span>,</span></span>
<span class="r-in"><span>                  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"If-None-Match"</span> <span class="op">=</span> <span class="va">file_hash</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># note status_code 304 Not Modified</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 304 Not Modified</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># provide a wrong hash, returns the file normally</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span>,</span></span>
<span class="r-in"><span>                  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"If-None-Match"</span> <span class="op">=</span> <span class="st">"WRONG HASH"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 200 OK</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Last-Modified: Thu, 18 Apr 2024 01:54:58 GMT</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ETag: b095e5e3</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># alternatively, you can provide a timestamp in the If-Modified-Since header</span></span></span>
<span class="r-in"><span><span class="co"># =&gt; 304 Not Modified (Can be cached)</span></span></span>
<span class="r-in"><span><span class="va">modified_since</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">last_modified</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">time_fmt</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span>,</span></span>
<span class="r-in"><span>                  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"If-Modified-Since"</span> <span class="op">=</span> <span class="va">modified_since</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 304 Not Modified</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># provide both headers: If-None-Match takes precedence</span></span></span>
<span class="r-in"><span><span class="co"># in this case:</span></span></span>
<span class="r-in"><span><span class="co">#  - if none match =&gt; modified (No cache)</span></span></span>
<span class="r-in"><span><span class="co">#  - if modified since =&gt; NOT MODIFIED (cached)</span></span></span>
<span class="r-in"><span><span class="co"># =&gt; Overall: modified = no cache</span></span></span>
<span class="r-in"><span><span class="va">modified_since</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">last_modified</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">time_fmt</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span>,</span></span>
<span class="r-in"><span>                  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"If-None-Match"</span> <span class="op">=</span> <span class="st">"CLEARLY WRONG"</span>,</span></span>
<span class="r-in"><span>                                 <span class="st">"If-Modified-Since"</span> <span class="op">=</span> <span class="va">modified_since</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 200 OK</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Last-Modified: Thu, 18 Apr 2024 01:54:58 GMT</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ETag: b095e5e3</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># provide matching hash of the file in the If-Match header to check Etag</span></span></span>
<span class="r-in"><span><span class="co"># =&gt; 412 Precondition Failed</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span>,</span></span>
<span class="r-in"><span>                  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"If-Match"</span> <span class="op">=</span> <span class="st">"OTHER HASH"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># note status_code 412 Precondition Failed</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 412 Precondition Failed</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use If-Unmodified-Since</span></span></span>
<span class="r-in"><span><span class="va">unmodified_since</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">last_modified</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">time_fmt</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span>,</span></span>
<span class="r-in"><span>                  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"If-Unmodified-Since"</span> <span class="op">=</span> <span class="va">unmodified_since</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># note status_code 412 Precondition Failed</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 412 Precondition Failed</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#############################################################################</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># use an alternative hash function (use name of the file)</span></span></span>
<span class="r-in"><span><span class="va">hash_on_filename</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span></span></span>
<span class="r-in"><span><span class="co"># also use an alternate last_modified time function</span></span></span>
<span class="r-in"><span><span class="va">always_1900</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXlt</a></span><span class="op">(</span><span class="st">"1900-01-01 12:34:56"</span>, tz <span class="op">=</span> <span class="st">"GMT"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># setup the app again</span></span></span>
<span class="r-in"><span><span class="va">app</span> <span class="op">=</span> <span class="va"><a href="Application.html">Application</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>middleware <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">ETagMiddleware</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>hash_function <span class="op">=</span> <span class="va">hash_on_filename</span>,</span></span>
<span class="r-in"><span>                     last_modified_function <span class="op">=</span> <span class="va">always_1900</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">add_static</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/"</span>, file_path <span class="op">=</span> <span class="va">static_dir</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># test the requests</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">res</span> <span class="op">=</span> <span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 200 OK</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Last-Modified: Mon, 01 Jan 1900 12:34:56 GMT</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ETag: /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpTW5Z2o/static/example.txt</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">filename</span> <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">body</span><span class="op">[[</span><span class="st">"file"</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">=</span> <span class="va"><a href="Request.html">Request</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/example.txt"</span>,</span></span>
<span class="r-in"><span>                  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"If-None-Match"</span> <span class="op">=</span> <span class="va">filename</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">app</span><span class="op">$</span><span class="fu">process_request</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;RestRserve Response&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   status code: 304 Not Modified</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   content-type: text/plain</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   &lt;Headers&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Server: RestRserve/1.2.2; Rserve/1.8.13</span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Dmitry Selivanov, Artem Klevtsov, <a href="https://rexy.ai" class="external-link"></a><a href="https://rexy.ai" class="external-link"><img src="https://s3-eu-west-1.amazonaws.com/rexy.ai/images/rexy-logo.svg" height="32" alt="rexy.ai"></a>.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

      </footer></div>

  


  

  </body></html>

